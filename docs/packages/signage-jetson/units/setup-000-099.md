# setup(000-099)

## **000_write_env_files.sh**

このスクリプトは、デバイスごとの識別子・ボード種別・GitHub/AWS の資格情報を引数で受け取り、**/etc/signage 配下に環境ファイルを生成**します。  
生成されるのは次の2つです。

- `/etc/signage/signage.env` …… 一般設定（権限 **644**）
- `/etc/signage/secret.env` …… 機密情報（権限 **600**）

これにより、以後のセットアップスクリプトや systemd サービスが**一貫した場所から設定・秘密情報を読み込める**ようになります。

また、6番目の**任意引数** `ASSUME_ROLE_ARN` に対応し、指定がなければ自動解決します（詳細は後述）。

> ### 実行方法

```bash
# ルート権限での実行を推奨
sudo bash scripts/setup/000_write_env_files.sh \
  <DEVICE_ID> <BOARD_TYPE> <GH_TOKEN> <AWS_ACCESS_KEY_ID> <AWS_SECRET_ACCESS_KEY> [ASSUME_ROLE_ARN]

# 例
sudo bash scripts/setup/000_write_env_files.sh \
  XIG-JON-000 jetsonorinnano ghp_xxxxxxxxxxxxxxxxxxxxx \
  AKIAxxxxxxxxxxxxxxxx wJalrXUtnFEMI/K7MDENG/bPxRfiCYxxxxxxxx

# 例（ASSUME_ROLE_ARN を明示）
sudo bash scripts/setup/000_write_env_files.sh \
  XIG-JON-000 jetsonorinnano ghp_xxxxxxxxxxxxxxxxxxxxx \
  AKIAxxxxxxxxxxxxxxxx wJalrXUtnFEMI/K7MDENG/bPxRfiCYxxxxxxxx \
  arn:aws:iam::123456789012:role/iot-provisioner-role
```

- `/etc/signage/signage.env`（権限: **0644**）

```dotenv
# Example environment variables for signage
SIGNAGE_CORE_DIR=<SIGNAGE_CORE_DIR>
DEVICE_ID=<DEVICE_ID>
BOARD_TYPE=<BOARD_TYPE>
NODE_ENV=production
ASSUME_ROLE_ARN=<RESOLVED_ASSUME_ROLE_ARN>
```

- `/etc/signage/secret.env`（権限: **0600**）

```dotenv
# Secret environment variables for signage
GH_TOKEN=<GH_TOKEN>
AWS_ACCESS_KEY_ID=<AWS_ACCESS_KEY_ID>
AWS_SECRET_ACCESS_KEY=<AWS_SECRET_ACCESS_KEY>
AWS_DEFAULT_REGION=ap-northeast-1
```

> **ASSUME_ROLE_ARN の解決ロジック**

1. **コマンド引数（第6引数）** `ASSUME_ROLE_ARN`
2. **シェル環境変数** `ASSUME_ROLE_ARN`
3. `$ROOT_DIR/signage.env.sample` の `ASSUME_ROLE_ARN=` 行
4. **既定値** `arn:aws:iam::<ACCOUNT_ID>:role/iot-provisioner-role`

---

## **005_apt_bootstrap.sh**

APT の **更新・アップグレード**と、`scripts/lib/config.sh` の `DEPENDENCIES` に定義された **ベース依存の一括導入**を行います。  
`BOARD_TYPE` に応じて Jetson/Pi の依存セットが変化します。

---

## **050_fix_hosts.sh**

現在のホスト名（`/etc/hostname`）が **/etc/hosts に自己解決可能なエントリ**として登録されているかを確認し、未登録なら **`127.0.1.1 <hostname>` を追記**します。

---

## **055_include_usercfg_pi.sh**

**Raspberry Pi 系ボードでのみ有効**。`/boot/firmware/config.txt` に **`include usercfg.txt`** を追記し、必要に応じて `dtoverlay=disable-bt` を設定します。

---

## **060_enable_uart_pi.sh**

**Raspberry Pi 系のみ**。`/boot/firmware/usercfg.txt` に `enable_uart=1` と `dtoverlay=disable-bt` を追記します。

---

## **062_setup_csi_camera_pi.sh**

**Raspberry Pi 系のみ**。CSI カメラ用のライブラリとビルド依存を導入し、`libcamera` スタックをセットアップします。非 Pi は安全にスキップします。

---

## **070_install_rtl8188eus.sh**

**Raspberry Pi 系のみ**。Realtek **RTL8188EUS** 用の DKMS ドライバ（`8188eu`）をビルド・導入します。  
競合する `r8188eu` はブラックリスト化します。

---

## **071_fix_wifi_names.sh**

Wi-Fi インタフェース名を **`wlanINT`（内蔵）／`wlanUSB`（USB）** に固定します。  
Pi は INT+USB が揃っていない場合は安全にスキップ、Jetson は `wlanINT` のみを扱います。

---

## **072_wifi_metrics.sh**

`systemd-networkd` の `.network` を生成し、**USB 優先（メトリック 50）/ 内蔵バックアップ（100）**の経路メトリックを固定します。

---

## **073_setup_journal.sh**

`systemd-journald` を **永続化**し、**総使用量 200MB** に制限します。

---

## **074_lock_snapd.sh**

**Raspberry Pi 以外**で snapd を固定バージョンにロックし、更新を hold します。

---

## **075_install_awscli.sh**

`/etc/signage/secret.env` の資格情報を読み込み、**AWS CLI v2 公式インストーラ**で導入します。  
その後 `aws configure set` で default プロファイルを構成し、`aws sts get-caller-identity` で確認します。

---

## **076_install_fluentbit.sh**

**Fluent Bit v4** を導入し、以下のパイプラインを構成します。

- **journald 全量 → S3**（`xignage-logs`、gzip 圧縮）
- **journald の error レベルのみ → CloudWatch Logs**（`/xignage/fluentbit`）
- **metrics（cpu/mem）→ S3**

さらに **CloudWatch Logs の保持期間を 14 日**に設定します（権限がある場合）。

---

## **080_initial_setup.sh**

**Python venv を作成し、pip 依存を venv に集約**します。既定の venv パスは **`/opt/signage-core/venv`**（`PYTHON_VENV_DIR` で上書き可）。  
`deps/pip-common.txt` を導入し、Raspberry Pi の場合は `deps/pip-raspi.txt` を **venv に追加**します。

その他、タイムゾーン/ロケール設定、時刻同期、DNS 固定化、`wpa_supplicant-<iface>.conf` の作成なども行います。

---

## **081_install_jetson_deps.sh**

**Jetson 専用**の依存導入スクリプトです。現在は **ログ出力のみ**で、`pip-jetson.txt` のインストールはコメントアウトされています。

---

## **085_enable_led_gpio18.sh**

**Raspberry Pi 系のみ**。GPIO18（BCM18）をブート時に **High 出力**へ設定し、LED を点灯させます。

---

## **086_install_gpio_button_shutdown_service.sh**

**Raspberry Pi 系のみ**。libgpiod を使う **長押しシャットダウン**ハンドラを配備し、`gpio-button-shutdown.service` を有効化します。  
デフォルトの GPIO は **BCM3**、`/etc/signage/io.env` の `SHUT_BTN_BCM` などで上書き可能です。

---

## **087_enable_gpio_shutdown_overlay.sh**

**Raspberry Pi 系のみ**。`/boot/firmware/config.txt` に `dtoverlay=gpio-shutdown,gpio_pin=23,active_low=1,gpio_pull=down` を設定します。  
既存の `gpio-shutdown` 行は削除して再設定し、**再起動が必要**です。

---

## **090_symlink_initial.sh**

`$SIGNAGE_JETSON_DIR/current` を **`releases/initial`** に固定するシンボリックリンクを作成します。
