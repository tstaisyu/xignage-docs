# setup(600-899)

## **600_signage_jetson.sh**

`update_runner` / `update_manager` / `healthcheck` を配置し、`signage-update.service` を生成します。  
`signage-update.service` は **oneshot** で `update_manager` を起動します。

- `EnvironmentFile=/etc/signage/signage.env`
- `TimeoutStartSec=15min` / `TimeoutStopSec=30s`
- `FailureAction=reboot`
- `REQUIRE_USERDATA=1` の場合は `RequiresMountsFor=/userdata` を追加

---

## **610_install_trt_runtime.sh**

**Jetson のみ**で TensorRT / PyCUDA / OpenCV (Python) の最小ランタイムを導入します。  
Pi は自動スキップされます。

---

## **700_jetson_server.sh**

コンテンツ格納ディレクトリを整備し、**linger 有効化**・
**ホスト名の正規化 + mDNS（Avahi）**を行います。  
`systemd --user` で `signage-server.service` を生成・有効化し、
`server.js` と `/etc/signage/iot.env` が揃っていれば起動します。

---

## **710_signage_server_port_override.sh**

`signage-server.service` の drop-in を作成し、`PORT=3001` を付与します。  
`server.js` と `/etc/signage/iot.env` が揃っていれば **再起動**します。

---

## **720_nginx_setup.sh**

Nginx の vhost を作成し、**`:3000 → 127.0.0.1:3001`** へリバースプロキシします。  
`/admin` の静的配信は行いません。

- `DEFAULT_SITE` を削除
- `sites-available/signage-device` を生成
- lighttpd が稼働中なら停止/無効化
- nginx を enable / start / reload

---

## **800_firewall.sh**

`config.sh` の UFW 設定に基づき、以下を適用します。

- **AP サブネット**からの deny/allow
- **AP インタフェース**への DHCP/DNS 許可
- 端末サービス用の **グローバル許可ポート**
- `ufw --force enable` と `reload` を実行

