# setup(100-199)

## **100_install_node.sh**

- Node.js を **Nodesource** から導入（`$NODE_VERSION`、失敗時は **20.x にフォールバック**）
- `signage-server` の最新リリースを GitHub Releases から取得し、**`releases/<timestamp>` に展開 → `current` 切替**
- `npm ci --omit=dev --ignore-scripts` で依存を導入

`signage-admin-ui` の取得・配信は **現行フローでは行いません**。

---

## **101_install_edge_detection.sh**

**Jetson のみ**で `xignage-edge-detection` を導入します（`BOARD_TYPE` に `pi`/`rasp` を含む場合はスキップ）。

- GitHub Releases から TAR/SHA を取得して検証
- `releases/<timestamp>` に展開し、`current` を切替
- `requirements-full.txt` が存在する場合のみ `pip3 install -r` を実行

---

## **105_install_metrics_service.sh**

`xignage-metrics` を `/opt/xignage-metrics` に同期し、**systemd サービス**として常駐化します。

- `METRICS_SRC → METRICS_DST` を `rsync --delete`
- 状態保存ディレクトリ `/var/lib/xignage-metrics` を作成（`700`）
- `npm ci --omit=dev` を実行
- `/etc/signage/iot.env` が存在しない場合は `iot.env.sample` を **600** で配置
- `/etc/systemd/system/xignage-metrics.service` を生成し `enable --now`

**IoT 接続情報は `/etc/signage/iot.env` に統一**されます。

---

## **106_install_call_button_service.sh**

**呼び鈴（インターホン）ボタン常駐デーモン**を導入し、`call-button.service` を作成・起動します。  
Raspberry Pi / Jetson の双方で動作（Python 側で GPIO ライブラリを自動選択）。

- 実行ファイル群（`/opt/local/bin/`）を `install_or_link` で配置
- `/etc/signage/io.env` を未存在時に生成
- `/var/log/signage` を作成
- `call-button.service` を **`/etc/signage/io.env` + `/etc/signage/iot.env`** で起動

### `/etc/signage/io.env`（既定・抜粋）

```dotenv
BUTTON_BOARD_PIN=5
BUTTON_DEBOUNCE_MS=30
STATE_PATH=/run/signage/io_state.json
EVENTS_PATH=/var/log/signage/io_events.jsonl

# ToF (optional)
# TOF_ENABLE=1
# TOF_MODEL=auto           # auto|vl53l0x|vl53l1x|none
# TOF_ADDR=0x29
# TOF_BUS=1
# TOF_THRESHOLD_MM=1200
# TOF_DISTANCE_MODE=2      # 0/1/2 = SHORT/MEDIUM/LONG
# TOF_TIMING_BUDGET_MS=50
```

---

## **111_set_assume_role_arn.sh**

`/etc/signage/signage.env` に `ASSUME_ROLE_ARN` を **追記/更新（アップサート）**します。  
存在しない場合は作成し、変更時は `.bak.<epoch>` を残します。

---

## **112_write_iot_env.sh**

**IoT 証明書の安全配置 + `/etc/signage/iot.env` の更新**を行います。  
`call-button.service` が存在する場合は **daemon-reload + restart** で反映します。

- 参照ファイル：
  - `/etc/signage/signage.env`（`DEVICE_ID`）
  - `/etc/signage/iot.env`（`IOT_ENDPOINT`）
- 証明書入力：
  - `/tmp/aws-iot-certs/{cert.pem,private.key,AmazonRootCA1.pem}` … **優先**
  - `/tmp/iot-certs/{cert.pem,private.key,AmazonRootCA1.pem}` … **フォールバック**
- 証明書配置先：`/etc/signage/iot-certs/<DEVICE_ID>/`（`0700`、`cert.pem/private.key=0600`、`AmazonRootCA1.pem=0644`）
- 生成/更新：`/etc/signage/iot.env`

```dotenv
IOT_ENDPOINT=<existing>
IOT_THING_NAME=<DEVICE_ID>
IOT_CERT_PATH=/etc/signage/iot-certs/<DEVICE_ID>/cert.pem
IOT_KEY_PATH=/etc/signage/iot-certs/<DEVICE_ID>/private.key
IOT_CA_PATH=/etc/signage/iot-certs/<DEVICE_ID>/AmazonRootCA1.pem
```

### **自動プロビジョニング（任意）**

- `CREATE_THING=1`（**既定 1**）で **Thing + 証明書の自動作成**を試行
- 既存 Thing の場合は `ROTATE_CERT_ON_EXISTING=1`（既定）で証明書ローテーション
- 利用ポリシー：`POLICY_NAME`（未指定時 `xignage-device-events-publish-v1`）
- `create_device_thing.sh` は以下も **冪等で実行**
  - Thing Group への追加（`xignage-devices`）
  - `monitor=true` 属性の付与

---

## **130_install_chromium_policies.sh**

Chromium の **managed policy** を導入し、キオスク時の **カメラ／マイク許可**を固定します。

- 配置先候補：`/var/snap/chromium/current/policies/managed` など
- 生成ファイル：`xignage.json`
- 許可 URL：
  - `http://127.0.0.1:3000`
  - `https://xrobotics.daily.co`
  - `https://api.xrobotics.jp`
