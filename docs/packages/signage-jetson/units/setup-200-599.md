# setup(200-599)

## **200_netplan_networkd_nm.sh**

有線は **systemd-networkd**、Wi-Fi は **NetworkManager** が担当する netplan を生成します。

- NetworkManager を enable/start
- systemd-networkd を enable/start
- `scripts/setup/templates/rootfs/etc/netplan/networkd-nm-wifi.yaml` を `/etc/netplan/50-ap.yaml` に配置

!!! note "注意"
    変更中に SSH が切断される可能性があります。可能ならローカルコンソールで実行してください。

---

## **300_hostapd_dnsmasq.sh**

AP は **NetworkManager ホットスポット**で運用するため、
**legacy hostapd / dnsmasq を無効化**します。

- `hostapd` / `dnsmasq` を disable + mask
- 旧設定ファイルを削除

---

## **400_ap_start_wifi_or_ap.sh**

`ap_start` / `wifi_or_ap` を配置し、`wifi-or-ap.service` と `wifi-or-ap.timer` を作成します。  
タイマーは **起動 30 秒後に実行**し、**非アクティブ後 20 秒**で再実行します。

- `wifi-or-ap.service` は `CONFIG_SH` を読み込んで `wifi_or_ap` を実行
- `/etc/signage/wifi-or-ap.env` でヒステリシス値を上書き可能

---

## **500_wifi_manager.sh**

Wi-Fi 設定 UI（`wifi_manager.py` / `index.html`）を Web ルートへ配置し、`wifi-manager.service` を作成します。

- 実行コマンド：`/opt/signage-core/venv/bin/python` で起動
- `WIFI_FLAG_FILE` を環境変数として注入

---

## **550_boot_optimize.sh**

バックグラウンド更新や不要サービスを抑制し、起動とリソース消費を最適化します。

- snapd の更新抑止とソケット起動化
- cloud-init / rpi-eeprom-update / networkd-dispatcher / fstrim などをマスク
- Bluetooth HCI を無効化

